var T=Object.defineProperty;var z=(o,e,t)=>e in o?T(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var l=(o,e,t)=>(z(o,typeof e!="symbol"?e+"":e,t),t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const h of r.addedNodes)h.tagName==="LINK"&&h.rel==="modulepreload"&&s(h)}).observe(document,{childList:!0,subtree:!0});function t(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(i){if(i.ep)return;i.ep=!0;const r=t(i);fetch(i.href,r)}})();var g=(o=>(o.i="#ff2a6d",o.j="#ff415a",o.l="#05d9e8",o.o="#0485b8",o.s="#d255e0",o.t="#4cffb4",o.z="#ebe04d",o.uiYellow="#FCED5E",o.uiPink="#ff577d",o.empty="#ccc",o))(g||{});class I{constructor(e,t){l(this,"rootElement");l(this,"width");l(this,"height");l(this,"viewSizeConstants");l(this,"canvas");l(this,"context");l(this,"opacityFull",1);l(this,"blockColors",["none",g.i,g.j,g.l,g.o,g.s,g.t,g.z]);this.rootElement=document.getElementById(e);const i=this.rootElement.offsetWidth<650?this.rootElement.offsetWidth:650;this.width=this.height=i,this.viewSizeConstants=this.getSizeConstants(i,t),this.canvas=document.createElement("canvas"),this.canvas.width=this.width,this.canvas.height=this.height,this.context=this.canvas.getContext("2d"),this.rootElement.appendChild(this.canvas)}getSizeConstants(e,t){const s=e/2*.02;return{width:e,height:e,relativeUnit:Math.round(e*.05),borderWidth:s,blockSide:(e/2-s*2)/t}}renderGame(e){const{board:t,gameSizeInBlocks:s,pause:i,started:r,lost:h}=e,f=i||!r||h;this.opacityFull=f?.5:1,this.clearView(),this.renderGameBoard(t,s),this.renderInfoBoard(e),f&&this.renderOverlay(e)}clearView(){this.context.clearRect(0,0,this.width,this.height)}renderGameBoard(e,t){const s=this.context,i=this.viewSizeConstants.width/2,r=this.viewSizeConstants.height-this.viewSizeConstants.borderWidth*2,{blockSide:h,borderWidth:f}=this.viewSizeConstants;s.globalAlpha=this.opacityFull,s.fillStyle="rgba(100, 100, 100, 0.2)",s.fillRect(0,0,i,r),s.lineWidth=this.viewSizeConstants.borderWidth,s.strokeStyle=g.uiPink,s.strokeRect(this.viewSizeConstants.borderWidth/2,this.viewSizeConstants.borderWidth/2,i-this.viewSizeConstants.borderWidth,r-this.viewSizeConstants.borderWidth);for(let d=0;d<t.height;d++)for(let a=0;a<t.width;a++)this.renderBlock({block:e[d][a],xInBlocks:a,yInBlocks:d,topX:h*.05+f,topY:h*.05+f})}renderInfoBoard(e){const{speed:t,speedChanged:s,score:i,scoreChanged:r,lines:h,linesChanged:f,nextPiece:d}=e,a=this.context,n=this.viewSizeConstants.width/2+this.viewSizeConstants.blockSide,{relativeUnit:c}=this.viewSizeConstants,w=this.wrapPieceWithEmptyBlocks(d),S=w.length,m=w[0].length;a.globalAlpha=this.opacityFull,a.textAlign="start",a.textBaseline="top",a.fillStyle=g.uiYellow,a.font=`normal ${.8*c}px VT323`,a.fillText(`Speed: ${t}`,n,c),s&&(a.fillStyle=g.uiPink,a.fillText(`+${s}`,n+2.5*c+t.toString().length*.3*c,c),a.fillStyle=g.uiYellow),a.fillText(`Score: ${i}`,n,c*2),r&&(a.fillStyle=g.uiPink,a.fillText(`+${r}`,n+2.5*c+i.toString().length*.3*c,c*2),a.fillStyle=g.uiYellow),a.fillText(`Lines: ${h}`,n,c*3),f&&(a.fillStyle=g.uiPink,a.fillText(`+${f}`,n+2.5*c+h.toString().length*.3*c,c*3),a.fillStyle=g.uiYellow),a.fillText("Next piece:",n,c*4),a.fillStyle="rgba(100, 100, 100, 0.2)",a.fillRect(n,c*5,m*this.viewSizeConstants.blockSide+this.viewSizeConstants.borderWidth,S*this.viewSizeConstants.blockSide+this.viewSizeConstants.borderWidth),a.lineWidth=this.viewSizeConstants.borderWidth/2,a.strokeStyle=g.uiPink,a.strokeRect(n-this.viewSizeConstants.borderWidth/4,c*5-this.viewSizeConstants.borderWidth/4,m*this.viewSizeConstants.blockSide+this.viewSizeConstants.borderWidth/2,S*this.viewSizeConstants.blockSide+this.viewSizeConstants.borderWidth/2);for(let v=0;v<S;v++)for(let p=0;p<m;p++)this.renderBlock({block:w[v][p],xInBlocks:p,yInBlocks:v,topX:n,topY:c*5})}renderBlock(e){const{block:t,xInBlocks:s,yInBlocks:i,topX:r,topY:h}=e,f=this.context,{blockSide:d}=this.viewSizeConstants;t?(f.globalAlpha=this.opacityFull,f.fillStyle=this.blockColors[t],f.fillRect(r+d*s,h+d*i,d*.9,d*.9)):(f.globalAlpha=.2,f.lineWidth=1,f.strokeStyle=g.empty,f.strokeRect(r+d*s,h+d*i,d*.9,d*.9))}renderOverlay(e){const{speed:t,score:s,lines:i,started:r,lost:h}=e,{relativeUnit:f,width:d,blockSide:a}=this.viewSizeConstants,n=this.context,c=d/2+a;n.globalAlpha=1,n.font=`${.8*f}px VT323`,n.textAlign="left",n.textBaseline="middle",n.fillStyle=g.uiYellow,r?h?(n.fillText("What a game!",c,d/2+f),n.fillStyle=g.uiPink,n.fillText("And by the numbers:",c,d/2+3*f),n.fillText(`🏆 score: ${s}`,c,d/2+4*f),n.fillText(`🧨 lines destroyed: ${i}`,c,d/2+5*f),n.fillText(`🔥 highest speed: ${t}`,c,d/2+6*f),n.fillStyle=g.uiYellow,n.fillText("Press Space to restart",c,d/2+8*f)):(n.fillText("Game paused",c,d/2+f),n.fillText("Press Space to resume",c,d/2+2*f)):(n.fillText("Press Space",c,d/2+f),n.fillText("to start the game!",c,d/2+2*f))}wrapPieceWithEmptyBlocks(e){const{figure:t}=e,{addLeft:s,addRight:i,addTop:r,addBottom:h,removeBottom:f}=t.reduce((n,c,w)=>{var S;if(w===0&&(n.addTop=c.some(m=>m!==0)),c[0]&&(n.addLeft=!0),c[c.length-1]&&(n.addRight=!0),w===e.height-1){const m=c.some(p=>p!==0),v=(S=t[e.height-2])==null?void 0:S.some(p=>p!==0);m?n.addBottom=!0:v||(n.removeBottom=!0)}return n},{addLeft:!1,addRight:!1,addTop:!1,addBottom:!1,removeBottom:!1}),d=s||i,a=r||h;if(d)for(const n of t)s&&n.unshift(0),i&&n.push(0);if(a){const c=this.getFigureString(t[0].length,0);r&&t.unshift(c),h&&t.push(c)}return f&&t.splice(e.height-1,1),t}getFigureString(e,t){const s=[];for(let i=0;i<e;i++)s.push(t);return s}}function C(o,e,t){const s=t.value;return{configurable:!0,get(){return s.bind(this)}}}var W=Object.defineProperty,R=Object.getOwnPropertyDescriptor,O=(o,e,t,s)=>{for(var i=s>1?void 0:s?R(e,t):e,r=o.length-1,h;r>=0;r--)(h=o[r])&&(i=(s?h(e,t,i):h(i))||i);return s&&i&&W(e,t,i),i};class k{constructor(e){l(this,"model");this.model=e,document.addEventListener("keydown",this.handleKeyDown)}handleKeyDown(e){switch(e.code){case"Space":this.model.handlePressSpace();break;case"ArrowLeft":this.model.handleNewTurn("left");break;case"ArrowUp":this.model.handleNewTurn("rotate");break;case"ArrowRight":this.model.handleNewTurn("right");break;case"ArrowDown":this.model.handleNewTurn("down");break}}}O([C],k.prototype,"handleKeyDown",1);function B(o){return JSON.parse(JSON.stringify(o))}function x(o){const e=new o.constructor;return Object.assign(e,o),e}class u{constructor(e){l(this,"y",-1);l(this,"x");l(this,"type");l(this,"figure");l(this,"fieldWidth");const s="ijlostz"[Math.floor(Math.random()*7)],i={i:[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]],j:[[0,0,0],[2,2,2],[0,0,2]],l:[[0,0,0],[3,3,3],[3,0,0]],o:[[0,0,0,0],[0,4,4,0],[0,4,4,0],[0,0,0,0]],s:[[0,0,0],[0,5,5],[5,5,0]],t:[[0,0,0],[6,6,6],[0,6,0]],z:[[0,0,0],[7,7,0],[0,7,7]]};this.fieldWidth=e,this.figure=i[s],this.type=s,this.x=Math.floor((e-this.figure[0].length)/2)}get width(){return this.figure[0].length}get height(){return this.figure.length}moveLeft(){this.x--}moveRight(){this.x++}moveDown(){this.y++}rotate(e=!0){const t=B(this.figure);e?this.figure=t[0].map((s,i)=>t.map(r=>r[i]).reverse()):this.figure=t[0].map((s,i)=>t.map(r=>r[r.length-1-i]))}}class P{constructor(e,t){l(this,"width");l(this,"height");l(this,"matrix");if(typeof e=="number"&&typeof t=="number"||!e){this.width=e||10,this.height=t||20;let s=[];for(let i=0;i<this.height;i++){const r=[];for(let h=0;h<this.width;h++)r.push(0);s.push(r)}this.matrix=s}else if(typeof e=="object"&&e[0])this.matrix=e,this.width=this.matrix[0].length,this.height=this.matrix.length;else throw new Error("Wrong params!")}deleteFilledRows(){const e=this.matrix.filter(s=>s.some(i=>i===0)),t=this.height-e.length;for(let s=0;s<t;s++)e.unshift(this.createEmptyRow());return this.matrix=e,t}addPieceToMatrix(e){this.matrix=b.mergePieceToBoard(this,e)}createEmptyRow(){const e=[];for(let t=0;t<this.width;t++)e.push(0);return e}}var E=Object.defineProperty,N=Object.getOwnPropertyDescriptor,_=(o,e,t,s)=>{for(var i=s>1?void 0:s?N(e,t):e,r=o.length-1,h;r>=0;r--)(h=o[r])&&(i=(s?h(e,t,i):h(i))||i);return s&&i&&E(e,t,i),i};const y=class{constructor(o,e){l(this,"view");l(this,"started");l(this,"pause");l(this,"lost",!1);l(this,"speed",0);l(this,"speedChanged",0);l(this,"score",0);l(this,"scoreChanged",0);l(this,"lines",0);l(this,"linesChanged",0);l(this,"interval");l(this,"gameSizeInBlocks");l(this,"gameBoardStatic");l(this,"currentPiece");l(this,"nextPiece");this.view=o,this.started=!1,this.pause=!0,this.interval=null,this.gameSizeInBlocks=e,this.gameBoardStatic=new P(this.gameSizeInBlocks.width,this.gameSizeInBlocks.height),this.currentPiece=new u(this.gameSizeInBlocks.width),this.nextPiece=new u(this.gameSizeInBlocks.width),this.view.renderGame(this.getState)}get getState(){return{speed:this.speed,speedChanged:this.speedChanged,score:this.score,scoreChanged:this.scoreChanged,lines:this.lines,linesChanged:this.linesChanged,board:y.mergePieceToBoard(this.gameBoardStatic,this.currentPiece),nextPiece:this.nextPiece,started:this.started,pause:this.pause,lost:this.lost,gameSizeInBlocks:this.gameSizeInBlocks}}startTimer(){const o=1e3-this.speed*100;this.pause=!1,this.view.renderGame(this.getState),this.interval||(this.interval=setInterval(this.handleNewTurn,o>0?o:100))}stopTimer(){this.interval&&(this.pause=!0,clearInterval(this.interval),this.interval=null),this.view.renderGame(this.getState)}handlePressSpace(){this.started?this.lost?this.resetGame():this.interval?this.stopTimer():this.startTimer():(this.started=!0,this.startTimer())}handleNewTurn(o){if(!(this.pause||this.lost)){if(o){let e;switch(o){case"left":e=this.handleIfPossible([[u.prototype.moveLeft]]);break;case"right":e=this.handleIfPossible([[u.prototype.moveRight]]);break;case"down":e=this.handleIfPossible([[u.prototype.moveDown]]);break;case"rotate":e=this.rotateCurrentPiece();break;default:e=!1}if(!e)return;o==="down"&&(this.scoreChanged=this.speed+1,this.score+=this.scoreChanged)}else{const e=this.handleIfPossible([[u.prototype.moveDown]]);if(!e&&this.currentPiece.y<0){this.lost=!0,this.view.renderGame(this.getState);return}e||(this.gameBoardStatic.addPieceToMatrix(this.currentPiece),this.updatePieces());const t=this.gameBoardStatic.deleteFilledRows();let s;if(this.lines+=t,this.linesChanged=t,this.scoreChanged=t?y.getScoreMultiplier(t)*(this.speed+1):0,this.score+=this.scoreChanged,s=Math.floor(this.lines/10),this.speedChanged=s-this.speed,this.speed=s,this.speedChanged){this.stopTimer(),this.startTimer();return}}this.view.renderGame(this.getState)}}rotateCurrentPiece(){const o=this.currentPiece.x<0?[[u.prototype.rotate],[u.prototype.moveRight,u.prototype.rotate],[u.prototype.moveRight,u.prototype.moveRight,u.prototype.rotate]]:this.currentPiece.x+this.currentPiece.width>this.gameBoardStatic.width?[[u.prototype.rotate],[u.prototype.moveLeft,u.prototype.rotate],[u.prototype.moveLeft,u.prototype.moveLeft,u.prototype.rotate]]:[[u.prototype.rotate]];return this.handleIfPossible(o)}handleIfPossible(o){for(let e=0;e<o.length;e++){const t=x(this.gameBoardStatic),s=x(this.currentPiece);if(o[e].forEach(i=>{i.call(s)}),!y.hasCollision(t,s))return o[e].forEach(i=>{i.call(this.currentPiece)}),!0}return!1}updatePieces(){this.currentPiece=this.nextPiece,this.nextPiece=new u(this.gameSizeInBlocks.width)}resetGame(){this.stopTimer(),this.lost=!1,this.started=!0,this.gameBoardStatic=new P(this.gameSizeInBlocks.width,this.gameSizeInBlocks.height),this.currentPiece=new u(this.gameSizeInBlocks.width),this.nextPiece=new u(this.gameSizeInBlocks.width),this.speed=0,this.speedChanged=0,this.score=0,this.scoreChanged=0,this.lines=0,this.linesChanged=0,this.startTimer()}static mergePieceToBoard(o,e){const{figure:t,y:s,x:i}=e,r=e.height,h=e.width,f=B(o.matrix);for(let d=0;d<r;d++)for(let a=0;a<h;a++){const n=t[d][a];n!==0&&(f[d+s][a+i]=n)}return f}static hasCollision(o,e){const{figure:t,y:s,x:i}=e;for(let r=0;r<e.height;r++)for(let h=0;h<e.width;h++)if(t[r][h]&&(!o.matrix[r+s]||o.matrix[r+s][h+i]===void 0||o.matrix[r+s][h+i]))return!0;return!1}static getScoreMultiplier(o){return[40,100,300,1200][o-1]||1}};let b=y;_([C],b.prototype,"handleNewTurn",1);class D{constructor(){l(this,"model");l(this,"view");l(this,"controller");l(this,"width",10);l(this,"height",20);const{height:e,width:t}=this;this.view=new I("game",t),this.model=new b(this.view,{height:e,width:t}),this.controller=new k(this.model)}}new D;
